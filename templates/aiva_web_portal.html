<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>AIVA - Vocational Assistant</title>
  <style>
    :root {
      /* ‚≠êÔ∏è CSS ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà (‡∏à‡∏≤‡∏Å aiva_portal.html) ‚≠êÔ∏è */
      --logo-width: 70vw;
      --tagline-size: 2.7rem;
      --video-frame-width: 490px;
      --video-frame-height: 780px;
      --video-width: 450px;
      --video-height: 750px;
      --button-font-size: 2.5rem;
      --button-width: 400px;
      --button-height: 110px;
      --button-radius: 18px;
      --button-border: 3px;
      --mic-size: 110px;
      --mic-font-size: 2.5rem;
    }
    html { box-sizing: border-box; }
    *, *:before, *:after { box-sizing: inherit; }
    body {
      margin: 0;
      min-height: 60vh;
      min-width: 0vw;
      font-family: 'Kanit', Tahoma, Arial, sans-serif;
      background: url('{{ url_for("static", filename="bg.png") }}') no-repeat center center fixed;
      background-size: cover;
      position: relative;
    }
    .container {
      width: 90vw;
      min-height: 80vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1;
    }
    .aiva-logo {
      margin-top: 30px;
      width: var(--logo-width);
    }
    .aiva-tagline {
      color: #fff;
      font-size: var(--tagline-size );
      font-weight: bold;
      margin-top: -40px;
      text-shadow: 0 2px 14px #000;
      text-align: center;
      letter-spacing: 0.04em;
    }
    .main-content {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: flex-start;
      margin-top: 36px;
      min-height: 420px;
      width: 100vw;
      position: relative;
      z-index: 1;
    }
    .video-and-speech {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-right: 48px;
      position: relative;
    }
    .video-frame {
      width: var(--video-frame-width);
      height: var(--video-frame-height);
      background: #18ed1800;
      border-radius: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 24px #0006;
    }
    .bot-video {
      width: var(--video-width);
      height: var(--video-height);
      border-radius: 36px;
      object-fit: cover;
      background: #222;
      display: block;
    }
    .right-panel {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
      width: 320px;
    }
    .actions {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 60px;
      width: 100%;
      margin-left: 75px;
    }
    .button-aiva {
      border: none;
      outline: none;
      font-size: var(--button-font-size );
      color: #fff;
      background: linear-gradient(90deg, #205FCF 70%, #265FF6 97%);
      border-radius: var(--button-radius);
      box-shadow: 0 4px 16px #07142218;
      width: var(--button-width);
      height: var(--button-height);
      min-width: 160px;
      cursor: pointer;
      position: relative;
      transition: background 0.2s, opacity 0.2s;
      letter-spacing: 2px;
      font-weight: bold;
      text-shadow: 0 2px 12px #2355ff77;
      border: var(--button-border) solid #24DDFF;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .button-aiva:hover {
      filter: brightness(1.09);
    }
    .button-aiva:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      filter: brightness(0.8);
    }
    .mic-float {
      position: absolute;
      left: 81%;
      bottom: -200px;
      transform: translateX(-50%);
      margin: 0;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 24px;
    }
    .mic-btn-image {
      width: var(--mic-size);
      height: var(--mic-size);
      padding: 1px;
      border: none;
      background: none;
      border-radius: 50%;
      box-shadow: 0 8px 34px #48fff977;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: box-shadow 0.2s, transform 0.2s;
      position: relative;
      z-index: 1;
    }
    .mic-btn-image:active {
      transform: scale(1.1) rotate(-6deg);
      box-shadow: 0 0 48px #4adcf7cc;
    }
    .mic-btn-image:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    .mic-btn-image.active {
      background: radial-gradient(circle, #c6e4fc 0%, #99e8ff90 70%, #6146e7 100%);
      box-shadow: 0 0 56px #65ebfd, 0 0 0 16px #ffffff18;
      transition: background 0.2s, box-shadow 0.3s;
    }
    .mic-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 50%;
      display: block;
      transition: transform 0.7s cubic-bezier(.24,1.56,.28,.78);
    }
    .mic-btn-image.active .mic-img {
      animation: mic-rotate 1s linear infinite;
    }
    @keyframes mic-rotate {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    .mic-stop-btn {
      width: 90px;
      height: 90px;
      background: radial-gradient(circle at 60% 30%, #e96487 60%, #715de7 120%);
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 24px #e9648799, 0 4px 16px #4738c966;
      transition: box-shadow 0.2s, transform 0.2s;
      cursor: pointer;
      position: relative;
    }
    .mic-stop-btn:hover {
      box-shadow: 0 0 40px #e96487cc, 0 6px 28px #715de7cc;
      transform: scale(1.07);
    }
    .mic-stop-icon {
      width: 40px;
      height: 40px;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 0 6px #fff8;
    }
    .speech-box {
      position: static;
      margin: 32px auto 0 auto;
      display: none;
      min-width: 340px;
      max-width: 480px;
      width: 78vw;
      min-height: 105px;
      padding: 32px 36px 28px 36px;
      background: rgba(255,255,255,0.19);
      border-radius: 34px;
      box-shadow: 0 12px 34px #0003, 0 0 0 6px #a5e9fc1f;
      backdrop-filter: blur(14px);
      z-index: 30;
      flex-direction: column;
      align-items: center;
      animation: popbox 0.44s cubic-bezier(.23,2,.19,.98);
    }
    @keyframes popbox {
      0% { opacity:0; transform:scale(0.7) translateY(80px);}
      60% { opacity:1; transform:scale(1.09) translateY(-20px);}
      100% { opacity:1; transform:scale(1) translateY(0);}
    }
    .speech-header {
      width: 100%;
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 18px;
      font-size: 2.1rem;
      color: #2856b8;
      font-weight: bold;
      letter-spacing: 1.2px;
      text-shadow: 0 2px 8px #fff6;
    }
    .speech-mic { font-size: 2.7rem; vertical-align: middle;}
    .speech-live-text {
      width: 100%;
      min-height: 50px;
      font-size: 1.65rem;
      color: #191b2b;
      font-weight: 600;
      text-shadow: 0 1px 10px #fff7;
      line-height: 1.6;
      transition: all 0.2s;
      letter-spacing: 0.5px;
      text-align: center;
    }
    .mic-loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(50,70,104,0.37);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.3s;
      pointer-events: none;
      opacity: 0;
      visibility: hidden;
    }
    .mic-loading-overlay.active {
      opacity: 1;
      pointer-events: auto;
      visibility: visible;
    }
    .emoji-loader-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 28px 32px 10px 32px;
      background: rgba(255,255,255,0.085);
      border-radius: 28px;
      box-shadow: 0 12px 36px #2c54ee28;
    }
    .emoji-bounce {
      display: flex;
      gap: 26px;
    }
    .emoji {
      font-size: 4.5rem;
      filter: drop-shadow(0 4px 22px hsl(var(--hue,210),90%,76%,0.30))
            hue-rotate(var(--hue,0)deg);
      animation: emoji-bounce 1s infinite cubic-bezier(.25,1.52,.29,1.03);
    }
    .emoji:nth-child(2) { animation-delay: 0.24s;}
    .emoji:nth-child(3) { animation-delay: 0.48s;}
    @keyframes emoji-bounce {
      0%,100% { transform: translateY(0);}
      45% { transform: translateY(-34px) scale(1.09);}
      60% { transform: scale(1);}
    }
    .mic-loader-message {
      margin-top: 28px;
      font-size: 2.1rem;
      color: #293c58;
      text-shadow: 0 2px 8px #fff7;
      font-weight: 700;
      letter-spacing: 1.2px;
      animation: message-blink 1.24s infinite alternate;
    }
    @keyframes message-blink {
      0%,100% { opacity: 1;}
      55% { opacity: 0.8;}
    }
    /* ‚≠êÔ∏è CSS ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Rating ‚≠êÔ∏è */
    .smile-emoji-btn {
      position: absolute;
      top: 32px;
      right: 5px;
      font-size: 5.2rem;
      cursor: pointer;
      z-index: 25;
      filter: drop-shadow(0 3px 10px #fff8);
      transition: transform 0.15s;
    }
    .smile-emoji-btn:active { transform: scale(1.09); }
    .rating-overlay {
      position: fixed;
      inset: 0;
      background: rgba(30,50,110,0.22);
      backdrop-filter: blur(12px);
      z-index: 500;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .rating-overlay.active { display: flex; }
    .rating-popup {
      background: rgba(255,255,255,0.96);
      border-radius: 32px;
      box-shadow: 0 12px 40px #27298e38;
      padding: 48px 40px 30px 40px;
      min-width: 268px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .rating-title {
      font-size: 2rem;
      color: #2752be;
      font-weight: bold;
      margin-bottom: 18px;
      text-shadow: 0 2px 8px #b0CAFF24;
    }
    .rating-stars {
      display: flex;
      gap: 18px;
      margin-bottom: 24px;
    }
    .rating-star {
      font-size: 2.4rem;
      cursor: pointer;
      transition: color 0.19s, transform 0.13s;
      color: #dde0e7;
      filter: drop-shadow(0 2px 8px #3798f849);
    }
    .rating-star.active,
    .rating-star:hover,
    .rating-star.selected {
      color: #ffc94a;
      transform: scale(1.14);
      filter: drop-shadow(0 2px 8px #F9BF36);
    }
    .rating-close {
      padding: 8px 26px;
      font-size: 1.2rem;
      background: #205FCF;
      color: #fff;
      border-radius: 15px;
      border: none;
      margin-top: 2px;
      cursor: pointer;
      transition: background 0.18s;
    }
    .rating-close:hover {
      background: #3279ec;
    }
    @media (max-width: 750px) {
      .main-content { flex-direction: column; align-items: center; }
      .video-and-speech { margin-right: 0;}
      .video-frame { width: 87vw; height: auto;}
      .speech-box{ min-width:120px; width:97vw; font-size:1.09rem;}
    }
  </style>
</head>
<body>
  <div class="container">
    <img class="aiva-logo" src="{{ url_for('static', filename='logo01.png') }}" alt="AIVA Logo"/>
    <!-- ‚≠êÔ∏è HTML ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Rating ‚≠êÔ∏è -->
    <div class="smile-emoji-btn" id="smile-btn" title="‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô">üòä</div>
    <div class="aiva-tagline">‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡∏∞‡πÅ‡∏´‡πà‡∏á‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</div>
    
    <div class="main-content">
      <div class="video-and-speech">
        <div class="video-frame">
          <video class="bot-video" controls autoplay loop muted>
            <source src="{{ url_for('static', filename='aivavideo.mp4') }}" type="video/mp4">
            ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
          </video>
        </div>
        <div class="speech-box" id="speech-box">
          <div class="speech-header">
            <span class="speech-mic">üé§</span>
            <span class="speech-status" id="speech-status">‡∏û‡∏π‡∏î‡πÄ‡∏•‡∏¢...</span>
          </div>
          <div class="speech-live-text" id="speech-live-text"></div>
        </div>
      </div>
      <div class="right-panel">
        
        <div class="actions">
          <button class="button-aiva">‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</button>
          <button class="button-aiva">‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</button>
          <button class="button-aiva">‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</button>
          
          <div class="mic-float mic-center">
            <button class="mic-btn-image" id="mic-btn" title="‡∏û‡∏π‡∏î">
              <img src="{{ url_for('static', filename='pu.png') }}" alt="Mic Wave" class="mic-img">
            </button>
            <button class="mic-stop-btn" id="stop-btn" title="‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏π‡∏î">
              <div class="mic-stop-icon"></div>
            </button>
          </div>
        </div>
        </div>
    </div>
    
    <div class="mic-loading-overlay" id="mic-loader">
      <div class="emoji-loader-wrap">
        <div class="emoji-bounce">
          <span class="emoji" style="--hue: 190;">üéß</span>
          <span class="emoji" style="--hue: 340;">ü§ñ</span>
          <span class="emoji" style="--hue: 75;">üéµ</span>
        </div>
        <div class="mic-loader-message" id="mic-loader-message">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ö‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...</div>
      </div>
    </div>
  </div>
  
  <!-- ‚≠êÔ∏è HTML ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Rating ‚≠êÔ∏è -->
  <div class="rating-overlay" id="rating-overlay">
    <div class="rating-popup">
      <div class="rating-title">‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à</div>
      <div class="rating-stars" id="rating-stars">
        <span class="rating-star" data-value="1">‚òÖ</span>
        <span class="rating-star" data-value="2">‚òÖ</span>
        <span class="rating-star" data-value="3">‚òÖ</span>
        <span class="rating-star" data-value="4">‚òÖ</span>
        <span class="rating-star" data-value="5">‚òÖ</span>
      </div>
      <button class="rating-close" id="rating-close">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <!-- ‚≠êÔ∏è‚≠êÔ∏è SCRIPT SECTION (Web App Architecture) ‚≠êÔ∏è‚≠êÔ∏è -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
      // --- Web Speech API (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå) ---
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      let recognition = null;
      
      if (SpeechRecognition) {
          recognition = new SpeechRecognition();
          recognition.lang = 'th-TH';
          recognition.continuous = false; // ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î‡∏à‡∏ö‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ
          recognition.interimResults = false; // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
      } else {
          console.error("Web Speech API is not supported in this browser.");
          // (‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡∏Ñ‡πå ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö)
      }

      // --- Audio Player (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Server) ---
      let audioPlayer = new Audio(); // ‚≠êÔ∏è ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πà‡∏ô MP3 ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤
      let currentAudioBlobUrl = null; // URL ‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô

      // --- Elements ---
      const micBtn = document.getElementById('mic-btn');
      const stopBtn = document.getElementById('stop-btn');
      const loader = document.getElementById('mic-loader');
      const loaderMessage = document.getElementById('mic-loader-message');
      const speechBox = document.getElementById('speech-box');
      const speechStatus = document.getElementById('speech-status');
      const speechLive = document.getElementById('speech-live-text');
      const buttons = document.querySelectorAll('.button-aiva');
      
      // ‚≠êÔ∏è Elements ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Rating ‚≠êÔ∏è
      const smileBtn = document.getElementById('smile-btn');
      const ratingOverlay = document.getElementById('rating-overlay');
      const ratingClose = document.getElementById('rating-close');
      const ratingStars = document.getElementById('rating-stars');

      // --- Helper Functions ---
      function showSpeechBox(status, text) {
          speechBox.style.display = "flex";
          speechStatus.textContent = status;
          speechLive.textContent = text;
      }

      function hideSpeechBox() {
          speechBox.style.display = "none";
          speechLive.textContent = "";
          speechStatus.textContent = "";
      }
      
      function resetUI() {
          micBtn.disabled = false;
          micBtn.classList.remove('active');
          loader.classList.remove('active');
          buttons.forEach(btn => btn.disabled = false);
      }
      
      /**
       * ‚≠êÔ∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á MP3 ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å Server
       */
      function playAudioFromResponse(response) {
          // 1. ‡∏î‡∏∂‡∏á URL ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Blob)
          response.blob().then(blob => {
              // 2. ‡∏î‡∏∂‡∏á Text ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡∏à‡∏≤‡∏Å Header ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡πà‡∏á‡∏°‡∏≤)
              // ‚≠êÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡πâ‡∏≠‡∏á Decode URI Component
              const answer = decodeURIComponent(window.atob(response.headers.get("X-Answer-Text") || ""));
              const question = decodeURIComponent(window.atob(response.headers.get("X-Question-Text") || ""));

              // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (Text) ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
              showSpeechBox(question, answer);
              
              // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå MP3
              const blobUrl = URL.createObjectURL(blob);
              currentAudioBlobUrl = blobUrl; // ‡πÄ‡∏Å‡πá‡∏ö URL ‡πÑ‡∏ß‡πâ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏¢‡∏∏‡∏î)
              
              // 5. ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ <audio> ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ
              audioPlayer.src = blobUrl;
              audioPlayer.play();
          });
          
          // 6. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏ö
          audioPlayer.onended = () => {
              console.log("Audio finished playing.");
              hideSpeechBox(); // ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
              if (currentAudioBlobUrl) {
                  URL.revokeObjectURL(currentAudioBlobUrl); // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ Memory
                  currentAudioBlobUrl = null;
              }
              // ‚≠êÔ∏è ‡∏ö‡∏≠‡∏Å Server ‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß
              fetch('/tts_finished_callback', { method: 'POST' }); 
          };
      }
      
      /**
       * ‚≠êÔ∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô (Client-side)
       */
      async function stopSpeech() {
          console.log("Stop button pressed.");
          
          // 1. ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ü‡∏±‡∏á (‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà)
          if (recognition) {
              recognition.stop();
          }
          
          // 2. ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô
          if (!audioPlayer.paused) {
              audioPlayer.pause();
              audioPlayer.currentTime = 0;
              if (currentAudioBlobUrl) {
                  URL.revokeObjectURL(currentAudioBlobUrl);
                  currentAudioBlobUrl = null;
              }
              // ‚≠êÔ∏è ‡∏ö‡∏≠‡∏Å Server ‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏´‡∏¢‡∏∏‡∏î
              await fetch('/tts_finished_callback', { method: 'POST' });
          }
          
          // 3. (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /stop_tts ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏≠‡∏á)
          
          // 4. Reset UI
          resetUI();
          hideSpeechBox();
      }

      // --- API Call Functions (Web App Architecture) ---

      /**
       * ‚≠êÔ∏è (‡∏õ‡∏∏‡πà‡∏° 3 ‡∏õ‡∏∏‡πà‡∏°) ‡∏™‡πà‡∏á Text -> ‡∏£‡∏±‡∏ö MP3
       */
      async function handleButtonPress(button, question) {
          await stopSpeech(); // ‡∏´‡∏¢‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
          
          button.disabled = true;
          buttons.forEach(btn => btn.disabled = true); // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏∑‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢

          try {
              console.log(`Calling /speak_answer with: ${question}`);
              const response = await fetch('/speak_answer', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ question })
              });

              if (!response.ok) {
                  throw new Error(`Server error: ${response.statusText}`);
              }
              
              playAudioFromResponse(response); // ‚≠êÔ∏è ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤

          } catch (error) {
              console.error('Error in handleButtonPress:', error);
              showSpeechBox("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", error.message);
          } finally {
              setTimeout(resetUI, 1000); // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
          }
      }

      /**
       * ‚≠êÔ∏è (‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡∏Ñ‡πå) ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á -> ‡∏™‡πà‡∏á Text -> ‡∏£‡∏±‡∏ö MP3
       */
      function startVoiceListen() {
          if (!recognition) {
              showSpeechBox("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢", "‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î");
              return;
          }

          stopSpeech(); // ‡∏´‡∏¢‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô

          micBtn.disabled = true;
          micBtn.classList.add('active'); 
          loaderMessage.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ö‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...";
          loader.classList.add('active'); 
          hideSpeechBox(); 

          recognition.start(); // ‚≠êÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Client-side)
      }
      
      // --- Event Listeners (Web Speech API) ---
      
      // ‚≠êÔ∏è ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Web Speech API ‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
      recognition.onresult = async (event) => {
          const text = event.results[0][0].transcript;
          console.log(`Speech recognized: ${text}`);
          
          // 1. ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
          loaderMessage.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö...";
          showSpeechBox(text, "..."); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
          
          // 2. ‡∏™‡πà‡∏á Text ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Server
          try {
              const response = await fetch('/listen', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ text }) // ‚≠êÔ∏è ‡∏™‡πà‡∏á Text ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ü‡∏±‡∏á‡πÑ‡∏î‡πâ
              });

              if (!response.ok) {
                   throw new Error(`Server error: ${response.statusText}`);
              }

              playAudioFromResponse(response); // ‚≠êÔ∏è ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
              
          } catch (error) {
              console.error('Error in recognition.onresult:', error);
              showSpeechBox(text, "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠");
          } finally {
              setTimeout(resetUI, 500); 
          }
      };

      // ‚≠êÔ∏è ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Web Speech API ‡∏ü‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à
      recognition.onerror = (event) => {
          console.error("Speech recognition error:", event.error);
          if (event.error === 'no-speech' || event.error === 'audio-capture') {
              showSpeechBox("AIVA", "‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏Ñ‡πà‡∏∞ ‡∏â‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì");
          } else {
              showSpeechBox("AIVA", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á");
          }
          resetUI();
      };
      
      // ‚≠êÔ∏è ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Web Speech API ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡πÉ‡∏î)
      recognition.onend = () => {
          if (loader.classList.contains('active')) {
              // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏î‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏≠‡∏á)
              resetUI();
          }
      };

      // --- Event Listeners (Buttons) ---
      const questions = [
          '‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£',
          '‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏≠‡∏ô',
          '‡∏à‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á'
      ];
      buttons.forEach((btn, i) => {
          btn.addEventListener('click', () => handleButtonPress(btn, questions[i]));
      });

      micBtn.addEventListener('click', startVoiceListen);
      stopBtn.addEventListener('click', stopSpeech); // ‚≠êÔ∏è ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏¢‡∏∏‡∏î (Client-side)
      
      // ‚≠êÔ∏è Event Listeners ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Rating ‚≠êÔ∏è
      smileBtn.addEventListener('click', () => {
        ratingOverlay.classList.add('active');
      });
      
      ratingClose.addEventListener('click', () => {
        ratingOverlay.classList.remove('active');
      });
      
      const allStars = ratingStars.querySelectorAll('.rating-star');
      
      allStars.forEach(star => {
        star.addEventListener('mouseover', () => {
          allStars.forEach(s => s.classList.remove('active'));
          let current = star;
          while (current) {
            current.classList.add('active');
            current = current.previousElementSibling;
          }
        });
        
        star.addEventListener('click', () => {
          const rating = star.dataset.value;
          console.log(`User rated: ${rating} stars`);
          
          allStars.forEach(s => s.classList.remove('selected', 'active'));
          let current = star;
          while (current) {
            current.classList.add('selected');
            current = current.previousElementSibling;
          }
        });
      });
      
      ratingStars.addEventListener('mouseleave', () => {
        allStars.forEach(s => s.classList.remove('active'));
      });
      
  });
  </script>
</body>
</html>